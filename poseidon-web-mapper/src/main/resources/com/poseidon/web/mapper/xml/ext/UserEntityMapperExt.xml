<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.poseidon.web.mapper.ext.UserEntityMapperExt">
    <resultMap id="BaseResultMap" type="com.poseidon.model.UserEntity">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Apr 21 14:33:25 CST 2017.
        -->
        <id column="user_id" jdbcType="VARCHAR" property="userId" />
        <result column="login_name" jdbcType="VARCHAR" property="loginName" />
        <result column="nick_name" jdbcType="VARCHAR" property="nickName" />
        <result column="cn_name" jdbcType="VARCHAR" property="cnName" />
        <result column="en_name" jdbcType="VARCHAR" property="enName" />
        <result column="pass_word" jdbcType="VARCHAR" property="passWord" />
        <result column="salt" jdbcType="VARCHAR" property="salt" />
        <result column="sex" jdbcType="TINYINT" property="sex" />
        <result column="age" jdbcType="TINYINT" property="age" />
        <result column="phone" jdbcType="VARCHAR" property="phone" />
        <result column="user_type" jdbcType="TINYINT" property="userType" />
        <result column="user_status" jdbcType="TINYINT" property="userStatus" />
        <result column="organization_id" jdbcType="INTEGER" property="organizationId" />
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    </resultMap>

    <select id="selectByLoginName" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
            user_id,
            login_name,
            nick_name,
            cn_name,
            en_name,
            pass_word,
            salt,
            sex,
            age,
            phone,
            user_type,
            user_status,
            organization_id,
            create_time
        FROM
            b2c_user
        WHERE
            login_name = #{loginName,jdbcType=VARCHAR}
        AND
            user_status = 1
    </select>

    <resultMap id="UserExt" type="com.poseidon.web.mapper.model.UserExt">
        <id column="user_id" jdbcType="VARCHAR" property="userId" />
        <result column="login_name" jdbcType="VARCHAR" property="loginName" />
        <result column="nick_name" jdbcType="VARCHAR" property="nickName" />
        <result column="cn_name" jdbcType="VARCHAR" property="cnName" />
        <result column="en_name" jdbcType="VARCHAR" property="enName" />
        <result column="pass_word" jdbcType="VARCHAR" property="passWord" />
        <result column="salt" jdbcType="VARCHAR" property="salt" />
        <result column="sex" jdbcType="TINYINT" property="sex" />
        <result column="age" jdbcType="TINYINT" property="age" />
        <result column="phone" jdbcType="VARCHAR" property="phone" />
        <result column="user_type" jdbcType="TINYINT" property="userType" />
        <result column="user_status" jdbcType="TINYINT" property="userStatus" />
        <result column="organization_id" jdbcType="INTEGER" property="organizationId" />
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
        <collection property="roleExtSet" ofType="com.poseidon.web.mapper.model.RoleExt" >
            <id column="role_id" jdbcType="VARCHAR" property="roleId" />
            <result column="role_name" jdbcType="VARCHAR" property="roleName" />
            <result column="seq" jdbcType="TINYINT" property="seq" />
            <result column="description" jdbcType="VARCHAR" property="description" />
            <result column="role_status" jdbcType="TINYINT" property="roleStatus" />
            <collection property="resourceExtSet" ofType="com.poseidon.web.mapper.model.ResourceExt">
                <id column="source_id" jdbcType="VARCHAR" property="sourceId" />
                <result column="source_name" jdbcType="VARCHAR" property="sourceName" />
                <result column="url" jdbcType="VARCHAR" property="url" />
                <result column="open_mode" jdbcType="VARCHAR" property="openMode" />
                <result column="description" jdbcType="VARCHAR" property="description" />
                <result column="icon" jdbcType="VARCHAR" property="icon" />
                <result column="pid" jdbcType="BIGINT" property="pid" />
                <result column="seq" jdbcType="TINYINT" property="seq" />
                <result column="resource_status" jdbcType="TINYINT" property="resourceStatus" />
                <result column="opened" jdbcType="TINYINT" property="opened" />
                <result column="resource_type" jdbcType="TINYINT" property="resourceType" />
                <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
            </collection>
        </collection>
    </resultMap>

    <select id="getUserWithRoleAndResource" parameterType="java.lang.String" resultType="java.util.Map">
        SELECT
          DISTINCT s.source_id,
            r.role_id,
            r.role_name AS roleName,
            r.seq,
            r.description,
            r.role_status,
            s.url,
            s.open_mode,
            s.description,
            s.icon,
            s.pid,
            s.seq,
            s.resource_status,
            s.opened,
            s.resource_type,
            s.create_time
        FROM
            b2c_user u
        LEFT JOIN org_role gr ON gr.org_id = u.organization_id
        LEFT JOIN role r ON r.role_id = gr.role_id
        LEFT JOIN role_resource rr ON rr.role_id = r.role_id
        LEFT JOIN resource s ON s.source_id = rr.resource_id
        WHERE
            u.login_name = #{loginName} AND   s.resource_status = 1
        AND
            u.user_status = 1
    </select>

    <select id="getAllUser" resultMap="BaseResultMap">
        SELECT
            user_id,
            login_name,
            nick_name,
            cn_name,
            en_name,
            pass_word,
            salt,
            sex,
            age,
            phone,
            user_type,
            user_status,
            organization_id,
            create_time
        FROM
            b2c_user
        WHERE
            user_status = 1
    </select>

    <update id="enable" parameterType="java.lang.String">
        update b2c_user
        set user_status = 1
        where user_id = #{userId,jdbcType=VARCHAR}
    </update>

    <update id="disable" parameterType="java.lang.String">
        update b2c_user
        set user_status = 0
        where user_id = #{userId,jdbcType=VARCHAR}
    </update>

    <delete id="deleteUserRolesByUserId" parameterType="java.lang.String">
        delete from user_role
        where user_id = #{userId,jdbcType=VARCHAR}
    </delete>

    <insert id="insertUserRoles" parameterType="java.lang.String">
        insert into user_role (user_role_id, user_id, role_id)
        values (#{uuid,jdbcType=VARCHAR}, #{userId,jdbcType=VARCHAR}, #{roleId,jdbcType=VARCHAR})
    </insert>

</mapper>