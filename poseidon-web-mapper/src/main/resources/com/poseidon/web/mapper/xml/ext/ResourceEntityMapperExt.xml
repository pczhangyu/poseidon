<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.poseidon.web.mapper.ext.ResourceEntityMapperExt">
  <resultMap id="BaseResultMap" type="com.poseidon.model.ResourceEntity">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Apr 21 14:33:25 CST 2017.
    -->
    <id column="source_id" jdbcType="VARCHAR" property="sourceId" />
    <result column="source_name" jdbcType="VARCHAR" property="sourceName" />
    <result column="url" jdbcType="VARCHAR" property="url" />
    <result column="open_mode" jdbcType="VARCHAR" property="openMode" />
    <result column="description" jdbcType="VARCHAR" property="description" />
    <result column="icon" jdbcType="VARCHAR" property="icon" />
    <result column="pid" jdbcType="BIGINT" property="pid" />
    <result column="seq" jdbcType="TINYINT" property="seq" />
    <result column="resource_status" jdbcType="TINYINT" property="resourceStatus" />
    <result column="opened" jdbcType="TINYINT" property="opened" />
    <result column="resource_type" jdbcType="TINYINT" property="resourceType" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
  </resultMap>

  <select id="getAllResource" resultMap="BaseResultMap">
    SELECT
        source_id,
        source_name,
        url,
        open_mode,
        description,
        icon,
        pid,
        seq,
        resource_status,
        opened,
        resource_type,
        create_time
    FROM
        resource
    WHERE
        resource_status = 1
</select>

  <select id="selectRoleResourcesByRoleId" parameterType="java.lang.String" resultMap="BaseResultMap">
    SELECT
        s.source_id,
        s.source_name,
        s.url,
        s.open_mode,
        s.description,
        s.icon,
        s.pid,
        s.seq,
        s.resource_status,
        s.opened,
        s.resource_type,
        s.create_time
    FROM
        resource s
    RIGHT JOIN role_resource rs ON rs.resource_id = s.source_id
    RIGHT JOIN role r ON r.role_id = rs.role_id
    WHERE
        r.role_id = #{userId,jdbcType=VARCHAR}
  </select>

    <select id="resourcesByRoleId" parameterType="java.lang.String" resultType="java.lang.String">
        SELECT
        resource_id
        FROM
        role_resource
        WHERE
        role_id = #{roleId,jdbcType=VARCHAR}
    </select>

  <update id="enable" parameterType="java.lang.String">
    update resource
    set resource_status = 1
    where resource_id = #{resourceId,jdbcType=VARCHAR}
  </update>

  <update id="disable" parameterType="java.lang.String">
    update resource
    set resource_status = 0
    where resource_id = #{resourceId,jdbcType=VARCHAR}
  </update>
  <select id="getParentMenusByUserId" parameterType="java.lang.String" resultType="java.util.Map">
    SELECT DISTINCT
        s.source_id as sourceId,
        s.source_name as sourceName,
        s.url,
        s.open_mode as openMode,
        s.description,
        s.icon,
        s.pid,
        s.seq,
        s.opened
    FROM
        b2c_user u
    LEFT JOIN org_role gr ON gr.org_id = u.organization_id
    LEFT JOIN role r ON r.role_id = gr.role_id
    LEFT JOIN role_resource rr ON rr.role_id = r.role_id
    LEFT JOIN resource s ON s.source_id = rr.resource_id
    WHERE
        u.user_id = #{userId,jdbcType=VARCHAR}
    AND s.resource_type = 0
    AND s.resource_status = 1
    AND (s.pid IS  NULL  OR  s.pid ='')
    AND u.user_status = 1 ORDER BY s.seq asc
  </select>

    <select id="getAllParentMenus" resultType="java.util.Map">
        SELECT DISTINCT
           source_id AS sourceId,
            source_name AS sourceName,
            url AS sourceUrl,
            open_mode AS openMode,
            description,
            icon,
            pid,
            seq,
            level_id AS level,
            resource_status AS resourceStatus,
            CASE
        WHEN resource_status = 1 THEN
            '启用'
        WHEN resource_status = 0 THEN
            '失效'
        ELSE
            '失效'
        END AS statusCn,
         opened,
         resource_type AS resourceType,
         CASE
        WHEN resource_type = 1 THEN
            '功能'
        WHEN resource_type = 0 THEN
            '菜单'
        ELSE
            '菜单'
        END AS typeCn,
         create_time as createTime
        FROM
       resource s
        WHERE
       resource_type = 0
        AND resource_status = 1
        AND (pid IS  NULL  OR  pid ='')
        ORDER BY seq asc
    </select>

    <select id="getChildrenMenusByUserId" parameterType="java.lang.String" resultType="java.util.Map">
        <![CDATA[
        SELECT DISTINCT
        s.source_id as sourceId,
        s.source_name as sourceName,
        s.url,
        s.open_mode as openMode,
        s.description,
        s.icon,
        s.pid,
        s.seq,
        s.opened
        FROM
        b2c_user u
        LEFT JOIN org_role gr ON gr.org_id = u.organization_id
        LEFT JOIN role r ON r.role_id = gr.role_id
        LEFT JOIN role_resource rr ON rr.role_id = r.role_id
        LEFT JOIN resource s ON s.source_id = rr.resource_id
        WHERE
        u.user_id = #{userId,jdbcType=VARCHAR}
        AND s.resource_type = 0
        AND s.resource_status = 1
        AND (s.pid IS NOT NULL  OR  s.pid <>'')
        AND u.user_status = 1 ORDER BY s.seq asc
    ]]>
    </select>

    <select id="getAllChildrenMenus"  resultType="java.util.Map">
        <![CDATA[
        SELECT DISTINCT
            s.source_id as sourceId,
            s.source_name as sourceName,
            s.url,
            s.open_mode as openMode,
            s.description,
            s.icon,
            s.pid,
            s.seq,
            s.opened
        FROM
        resource s
        WHERE
        s.resource_type = 0
        AND s.resource_status = 1
        AND (s.pid IS NOT NULL  OR  s.pid <>'')
        ORDER BY s.seq asc
    ]]>
    </select>

    <select id="getAllChildrenMenusBySourceId"  parameterType="java.lang.String" resultType="java.util.Map">
        <![CDATA[
        SELECT DISTINCT
            source_id AS sourceId,
            source_name AS sourceName,
            url AS sourceUrl,
            open_mode AS openMode,
            description,
            icon,
            pid,
            seq,
            level_id AS level,
            resource_status AS resourceStatus,
            CASE
        WHEN resource_status = 1 THEN
            '启用'
        WHEN resource_status = 0 THEN
            '失效'
        ELSE
            '失效'
        END AS statusCn,
         opened,
         resource_type AS resourceType,
         CASE
        WHEN resource_type = 1 THEN
            '功能'
        WHEN resource_type = 0 THEN
            '菜单'
        ELSE
            '菜单'
        END AS typeCn,
         create_time as createTime
        FROM
        resource
        WHERE
        pid = #{sourceId,jdbcType=VARCHAR}
        AND resource_status = 1
        AND (pid IS NOT NULL  OR  pid <>'')
        ORDER BY seq asc
    ]]>
    </select>

    <select id="queryResourceList" resultType="java.util.Map">
        SELECT
            source_id AS sourceId,
            source_name AS sourceName,
            url,
            open_mode AS openMode,
            description,
            icon,
            pid,
            seq,
            level_id AS level,
            resource_status AS resourceStatus,
            CASE
        WHEN resource_status = 1 THEN
            '启用'
        WHEN resource_status = 0 THEN
            '失效'
        ELSE
            '失效'
        END AS statusCn,
         opened,
         resource_type AS resourceType,
         CASE
        WHEN resource_type = 1 THEN
            '功能'
        WHEN resource_type = 0 THEN
            '菜单'
        ELSE
            '菜单'
        END AS typeCn,
         create_time as createTime
        FROM
            resource
    </select>

    <update id="deleteByResourceId">
        UPDATE
            resource
        SET
            is_delete ='Y'
    </update>

</mapper>